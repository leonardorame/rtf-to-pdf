-- this table holds the list of to-be-sent documents

create table docstosend(
  id serial not null,
  accession varchar(50) not null,
  doc_name varchar(50),
  doc_header text,
  doc_body text,
  doc_footer text,
  created timestamp default current_timestamp,
  sent boolean default false,
  sent_date timestamp,
  primary key(id)
);

-- Crear el siguiente trigger en la tabla turno:

create or replace function addtodocstosend() 
returns trigger as
$$
declare
  docs RECORD;
begin
  -- get documents
  for docs in 
    select 
      d.nombredocumento
    from turnodocumento d
    where d.idturno = NEW.idturno and NEW.estadoinfres='D'
  LOOP
    insert into docstosend(accession, doc_name)
      values(NEW.turnosistemaexterno, docs.nombredocumento);
  END LOOP;
  RETURN null;
end;
$$ language plpgsql;

create trigger tr_addtodocstosend
  after update on turno
  for each row
  execute procedure addtodocstosend();
